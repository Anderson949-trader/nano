<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Profesional de Trading Forex</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #27ae60;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --info: #3498db;
            --bg-primary: #f4f7f9;
            --bg-secondary: #ffffff;
            --text-primary: #34495e;
            --text-secondary: #7f8c8d;
            --border: #e0e0e0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --gradient-card: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        [data-theme='dark'] {
            --primary: #4a90e2;
            --secondary: #2d3748;
            --accent: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --border: #4a5568;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            --gradient-card: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); min-height: 100vh; padding: 10px; transition: all 0.3s ease; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--bg-secondary); border-radius: 20px; box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
        .header { background: var(--secondary); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .header p { color: var(--text-secondary); }
        .main-content { padding: 20px; }
        .section { margin-bottom: 30px; background: var(--bg-secondary); border-radius: 15px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); transition: all 0.3s ease; }
        .section h2 { color: var(--text-primary); margin-bottom: 20px; font-size: 1.6em; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        .session-info { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; }
        .session-card { background: var(--bg-primary); border: 2px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; flex: 1; min-width: 180px; }
        .session-card h3 { margin-bottom: 10px; color: var(--primary); font-size: 1.1em; }
        .session-card p { font-size: 1em; font-weight: 600; }
        .controls-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-row.grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .form-row.grid-4 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; background-color: var(--bg-primary); color: var(--text-primary); transition: all 0.3s ease; font-family: var(--font-family); }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 10px rgba(52, 152, 219, 0.3); }
        button { padding: 12px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s ease; color: white; background-color: var(--primary); display: inline-flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        button:disabled { background-color: var(--text-secondary); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-small { padding: 6px 12px; font-size: 12px; width: auto; }
        .btn-danger { background-color: var(--danger); }
        .btn-success { background-color: var(--accent); }
        .btn-secondary { background-color: var(--secondary); }
        .btn-icon { display: inline-flex; align-items: center; gap: 8px; }
        .accounts-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .account-card { background: var(--gradient-card); border: 2px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; transition: all 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; }
        .account-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
        .account-card h3 { margin-bottom: 10px; font-size: 1.5em; color: var(--primary); }
        .account-card p { font-size: 0.9em; color: var(--text-secondary); }
        .account-card strong { color: var(--text-primary); }
        .account-actions { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .table-container { overflow-x: auto; margin-top: 20px; border: 1px solid var(--border); border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: var(--bg-secondary); overflow: hidden; min-width: 1200px; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; white-space: nowrap; }
        th:first-child, td:first-child { padding-left: 15px; }
        th:last-child, td:last-child { padding-right: 15px; }
        th { background: var(--secondary); color: white; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:hover { background-color: var(--bg-primary); }
        .profit { color: var(--accent); font-weight: 600; }
        .loss { color: var(--danger); font-weight: 600; }
        .neutral { color: var(--text-secondary); }
        .warning { color: var(--warning); }
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .report-card { background: var(--gradient-card); border-radius: 15px; padding: 25px; border: 2px solid var(--border); transition: all 0.3s ease; }
        .report-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
        .report-title { font-size: 1.2em; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
        .metric { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 0; border-bottom: 1px dashed var(--border); }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; color: var(--text-secondary); }
        .metric-value { font-weight: 600; color: var(--text-primary); }
        .percentage { font-size: 1.1em; padding: 5px 10px; border-radius: 20px; color: white; }
        .percentage.positive { background-color: var(--accent); }
        .percentage.negative { background-color: var(--danger); }
        .tabs { display: flex; margin-bottom: 20px; background: var(--bg-primary); border-radius: 10px; padding: 5px; flex-wrap: wrap; }
        .tab { flex: 1; padding: 12px; text-align: center; background: transparent; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-secondary); transition: all 0.3s ease; min-width: 100px; }
        .tab.active { background-color: var(--primary); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .chart-container { background: var(--bg-primary); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); min-height: 400px; }
        .label-group { display: flex; flex-direction: column; gap: 5px; }
        .label-group input, .label-group select, .label-group textarea { padding: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-secondary); margin: 15% auto; padding: 20px; border: 1px solid var(--border); width: 80%; max-width: 500px; border-radius: 15px; position: relative; box-shadow: var(--shadow); }
        .close-btn { color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: var(--primary); text-decoration: none; cursor: pointer; }
        @media (max-width: 768px) {
            body { padding: 0; }
            .container { border-radius: 0; border: none; }
            .form-row, .form-row.grid-3, .form-row.grid-4 { grid-template-columns: 1fr; }
            .accounts-list, .reports-grid, .session-info { grid-template-columns: 1fr; }
            .controls-bar { flex-direction: column; align-items: stretch; }
            .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .trade-form-section { padding-bottom: 80px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Registro Profesional de Trading</h1>
            <p>Sistema avanzado de seguimiento, gesti√≥n y an√°lisis</p>
        </div>

        <div class="main-content">
            <div class="controls-bar">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="theme-toggle" class="btn-secondary btn-icon">üåì Modo Oscuro</button>
                    <button onclick="exportToCSV()" class="btn-primary btn-icon">üíæ Exportar CSV</button>
                    <button onclick="clearAllData()" class="btn-danger btn-icon">üóëÔ∏è Borrar Todos los Datos</button>
                </div>
            </div>

            <div class="section" id="accounts-section">
                <h2>üè¶ Gesti√≥n de Cuentas</h2>
                <div class="form-row grid-3">
                    <div>
                        <label for="accountName">Nombre de la Cuenta:</label>
                        <input type="text" id="accountName" placeholder="Ej: Cuenta Principal">
                    </div>
                    <div>
                        <label for="initialCapital">Capital Inicial ($):</label>
                        <input type="number" id="initialCapital" placeholder="1000" step="0.01">
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button onclick="addAccount()" class="btn-success btn-icon">‚ûï Agregar Cuenta</button>
                    </div>
                </div>
                <div class="accounts-list" id="accountsList"></div>
            </div>

            <div class="section">
                <h2>üßÆ Calculadora de Tama√±o de Posici√≥n</h2>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    Calcula el lotaje exacto para arriesgar un % de tu capital en cada operaci√≥n.
                </p>
                <div class="form-row grid-3">
                    <div>
                        <label for="posCalcAccount">Seleccionar Cuenta:</label>
                        <select id="posCalcAccount"></select>
                    </div>
                    <div>
                        <label for="posCalcRisk">Riesgo (%):</label>
                        <input type="number" id="posCalcRisk" placeholder="1" step="0.1" value="1">
                    </div>
                    <div>
                        <label for="posCalcStopLoss">Stop Loss (Pips):</label>
                        <input type="number" id="posCalcStopLoss" placeholder="20" step="0.1">
                    </div>
                </div>
                <div class="form-row grid-3">
                    <div class="label-group">
                        <label for="posCalcPair">Par de Divisas (opcional):</label>
                        <select id="posCalcPair">
                            <option value="">Seleccionar</option>
                            <option value="EUR/USD">EUR/USD</option><option value="GBP/USD">GBP/USD</option><option value="USD/JPY">USD/JPY</option><option value="USD/CHF">USD/CHF</option><option value="AUD/USD">AUD/USD</option><option value="USD/CAD">USD/CAD</option><option value="NZD/USD">NZD/USD</option><option value="EUR/GBP">EUR/GBP</option><option value="EUR/JPY">EUR/JPY</option><option value="GBP/JPY">GBP/JPY</option><option value="XAU/USD">XAU/USD (Oro)</option><option value="SPX500">SPX500</option>
                        </select>
                    </div>
                    <div class="label-group">
                        <label for="posCalcPipValue">Valor del Pip por Lote Est√°ndar (opcional):</label>
                        <input type="number" id="posCalcPipValue" placeholder="10" step="0.01">
                    </div>
                </div>
                <button onclick="calculatePositionSize()" class="btn-primary btn-icon" style="width: 100%;">üìè Calcular Lotaje</button>
                <div id="positionSizeResult" style="margin-top: 20px; text-align: center; font-size: 1.5em; font-weight: bold;"></div>
            </div>

            <div class="section" id="trade-form-section">
                <h2>üìä Registro de Operaciones</h2>
                <form id="tradeForm">
                    <input type="hidden" id="editTradeId">
                    <div class="form-row">
                        <div>
                            <label for="accountSelect">Cuenta:</label>
                            <select id="accountSelect" required></select>
                        </div>
                        <div>
                            <label for="currencyPair">Par de Divisas:</label>
                            <select id="currencyPair" required>
                                <option value="EUR/USD">EUR/USD</option><option value="GBP/USD">GBP/USD</option><option value="USD/JPY">USD/JPY</option><option value="USD/CHF">USD/CHF</option><option value="AUD/USD">AUD/USD</option><option value="USD/CAD">USD/CAD</option><option value="NZD/USD">NZD/USD</option><option value="EUR/GBP">EUR/GBP</option><option value="EUR/JPY">EUR/JPY</option><option value="GBP/JPY">GBP/JPY</option><option value="XAU/USD">XAU/USD (Oro)</option><option value="SPX500">SPX500</option>
                            </select>
                        </div>
                        <div>
                            <label for="operationType">Tipo de Operaci√≥n:</label>
                            <select id="operationType" required>
                                <option value="BUY">COMPRA (BUY)</option><option value="SELL">VENTA (SELL)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row grid-4">
                        <div><label for="pipsWon">Pips Ganados:</label><input type="number" id="pipsWon" placeholder="25" step="0.1" min="0" data-toggle-money="won"></div>
                        <div><label for="pipsLost">Pips Perdidos:</label><input type="number" id="pipsLost" placeholder="0" step="0.1" min="0" data-toggle-money="lost"></div>
                        <div><label for="moneyWon">Dinero Ganado ($):</label><input type="number" id="moneyWon" placeholder="250" step="0.01" min="0" data-toggle-pips="won"></div>
                        <div><label for="moneyLost">Dinero Perdido ($):</label><input type="number" id="moneyLost" placeholder="0" step="0.01" min="0" data-toggle-pips="lost"></div>
                    </div>

                    <div class="form-row">
                        <div><label for="closeDate">üìÖ Fecha de Cierre:</label><input type="date" id="closeDate" required></div>
                        <div>
                             <label for="session">üåç Sesi√≥n:</label>
                             <select id="session" required>
                                <option value="">Seleccionar Sesi√≥n</option><option value="Sydney">Sydney</option><option value="Tokyo">Tokyo</option><option value="London">London</option><option value="New York">New York</option><option value="Ninguna">Ninguna</option>
                             </select>
                        </div>
                        <div><label for="stopLossPips">Stop Loss (Pips):</label><input type="number" id="stopLossPips" placeholder="15" step="0.1" min="0"></div>
                        <div><label for="lotSize">Lote (Ej: 0.10):</label><input type="number" id="lotSize" placeholder="0.10" step="0.01" min="0"></div>
                    </div>

                    <div>
                        <label for="tradeNotes">üìù Notas de la Operaci√≥n (Diario de Trading):</label>
                        <textarea id="tradeNotes" placeholder="¬øPor qu√© tom√© esta operaci√≥n? ¬øSegu√≠ mi plan? ¬øQu√© emociones sent√≠?"></textarea>
                    </div>

                    <button type="submit" class="btn-success btn-icon" id="submitTradeBtn" style="margin-top: 15px;">üíæ Registrar Operaci√≥n</button>
                </form>
            </div>

            <div class="section">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('history', this)">üìã Historial</button>
                    <button class="tab" onclick="showTab('reports', this)">üìà Reportes</button>
                </div>

                <div id="history" class="tab-content active">
                    <h2>üìã Historial de Operaciones</h2>
                    <div class="controls-bar" style="justify-content: flex-start; gap: 10px;">
                        <input type="text" id="filterPair" placeholder="Filtrar por Par..." style="width: 200px;">
                        <button onclick="filterTrades()" class="btn-primary btn-small">Filtrar</button>
                        <button onclick="clearFilter()" class="btn-secondary btn-small">Limpiar</button>
                    </div>
                    <div class="table-container">
                        <table id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Cuenta</th><th>F. Cierre</th><th>Sesi√≥n</th><th>Par</th><th>Tipo</th><th>Pips Œî</th><th>P&L Total</th><th>R:R</th><th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tradesBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="reports" class="tab-content">
                    <h2>üìà Reportes y Estad√≠sticas</h2>
                    <div class="reports-grid" id="reportsContainer"></div>
                    <div class="chart-container">
                        <h3>Evoluci√≥n del Capital (Curva de Equity)</h3>
                        <canvas id="balanceChart"></canvas>
                    </div>
                    <div class="reports-grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
                        <div class="chart-container">
                            <h3>Rendimiento por Activo ($)</h3>
                            <canvas id="assetPerformanceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Rendimiento por D√≠a de la Semana ($)</h3>
                            <canvas id="dayPerformanceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Rendimiento por Tipo de Operaci√≥n</h3>
                            <canvas id="typePerformanceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Distribuci√≥n de Pips (Histograma)</h3>
                            <canvas id="pipsDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notesModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 style="margin-bottom: 10px;">Notas de la Operaci√≥n</h3>
            <p id="modal-notes-content"></p>
        </div>
    </div>

    <script>
        let accounts = [];
        let trades = [];
        let tradeIdCounter = 1;
        let balanceChart, assetPerformanceChart, dayPerformanceChart, typePerformanceChart, pipsDistributionChart;

        const STORAGE_KEY = 'forexData_v5';
        const pipValues = {
            'EUR/USD': 10, 'GBP/USD': 10, 'AUD/USD': 10, 'NZD/USD': 10,
            'USD/JPY': 9.2, 'USD/CHF': 9.1, 'USD/CAD': 7.5,
            'XAU/USD': 10, 'SPX500': 1
        };

        // ===================================
        // C√ÅLCULOS Y L√ìGICA DE TRADING
        // ===================================
        function calculatePositionSize() {
            const accountId = document.getElementById('posCalcAccount').value;
            const riskPercent = parseFloat(document.getElementById('posCalcRisk').value);
            const stopLossPips = parseFloat(document.getElementById('posCalcStopLoss').value);
            const pair = document.getElementById('posCalcPair').value;
            let pipValue = parseFloat(document.getElementById('posCalcPipValue').value);
            const resultContainer = document.getElementById('positionSizeResult');

            const account = accounts.find(acc => acc.id == accountId);

            if (!account || isNaN(riskPercent) || isNaN(stopLossPips) || stopLossPips <= 0) {
                resultContainer.innerHTML = `<span class="warning">Por favor, completa los campos requeridos correctamente.</span>`;
                return;
            }

            if (isNaN(pipValue) && pair && pipValues[pair]) {
                pipValue = pipValues[pair];
            } else if (isNaN(pipValue)) {
                pipValue = 10; // Valor por defecto
            }
            
            const capitalToRisk = account.currentBalance * (riskPercent / 100);
            const valuePerPip = capitalToRisk / stopLossPips;
            const lotSize = valuePerPip / pipValue;

            resultContainer.innerHTML = `Lotaje Recomendado: <span class="profit">${lotSize.toFixed(2)}</span>`;
        }

        function showNotes(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (trade && trade.notes) {
                document.getElementById('modal-notes-content').innerText = trade.notes;
                document.getElementById('notesModal').style.display = 'flex';
            } else {
                alert('No hay notas para esta operaci√≥n.');
            }
        }

        function closeModal() {
            document.getElementById('notesModal').style.display = 'none';
        }
        
        // ===================================
        // GESTI√ìN DE DATOS (CRUD)
        // ===================================
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ accounts, trades, tradeIdCounter }));
        }

        function loadData() {
            const dataString = localStorage.getItem(STORAGE_KEY);
            if (dataString) {
                const data = JSON.parse(dataString);
                accounts = data.accounts || [];
                trades = data.trades || [];
                tradeIdCounter = data.tradeIdCounter || 1;
            }
        }
        
        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar TODOS los datos? Esta acci√≥n es irreversible.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        function addAccount() {
            const nameInput = document.getElementById('accountName');
            const capitalInput = document.getElementById('initialCapital');
            const name = nameInput.value.trim();
            const capital = parseFloat(capitalInput.value) || 0;
            
            if (!name) {
                alert('‚ùå El nombre de la cuenta no puede estar vac√≠o.');
                return;
            }
            if (accounts.find(acc => acc.name.toLowerCase() === name.toLowerCase())) {
                alert('‚ùå Ya existe una cuenta con ese nombre.');
                return;
            }
            
            accounts.push({ id: Date.now(), name, initialCapital: capital, currentBalance: capital });
            nameInput.value = '';
            capitalInput.value = '';
            saveData();
            refreshAll();
        }

        function editAccount(accountId) {
            const newName = prompt('Introduce el nuevo nombre de la cuenta:');
            if (newName && newName.trim() !== '') {
                const account = accounts.find(acc => acc.id === accountId);
                if (account) {
                    account.name = newName.trim();
                    saveData();
                    refreshAll();
                }
            }
        }

        function deleteAccount(accountId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta cuenta? Se borrar√°n todas las operaciones asociadas.')) {
                accounts = accounts.filter(acc => acc.id !== accountId);
                trades = trades.filter(trade => trade.accountId !== accountId);
                saveData();
                refreshAll();
            }
        }

        function editTrade(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;

            document.getElementById('editTradeId').value = trade.id;
            document.getElementById('accountSelect').value = trade.accountId;
            document.getElementById('currencyPair').value = trade.currencyPair;
            document.getElementById('operationType').value = trade.operationType;
            document.getElementById('pipsWon').value = trade.pipsWon;
            document.getElementById('pipsLost').value = trade.pipsLost;
            document.getElementById('moneyWon').value = trade.moneyWon;
            document.getElementById('moneyLost').value = trade.moneyLost;
            document.getElementById('closeDate').value = trade.closeDate;
            document.getElementById('session').value = trade.session;
            document.getElementById('stopLossPips').value = trade.stopLossPips;
            document.getElementById('lotSize').value = trade.lotSize;
            document.getElementById('tradeNotes').value = trade.notes;

            document.getElementById('submitTradeBtn').innerText = 'üíæ Actualizar Operaci√≥n';
            document.getElementById('submitTradeBtn').classList.remove('btn-success');
            document.getElementById('submitTradeBtn').classList.add('btn-primary');
            
            document.getElementById('trade-form-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        function deleteTrade(tradeId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta operaci√≥n?')) {
                trades = trades.filter(trade => trade.id !== tradeId);
                saveData();
                refreshAll();
            }
        }

        document.getElementById('tradeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const editId = parseInt(document.getElementById('editTradeId').value);

            const tradeData = {
                accountId: parseInt(document.getElementById('accountSelect').value),
                currencyPair: document.getElementById('currencyPair').value,
                operationType: document.getElementById('operationType').value,
                pipsWon: parseFloat(document.getElementById('pipsWon').value) || 0,
                pipsLost: parseFloat(document.getElementById('pipsLost').value) || 0,
                moneyWon: parseFloat(document.getElementById('moneyWon').value) || 0,
                moneyLost: parseFloat(document.getElementById('moneyLost').value) || 0,
                closeDate: document.getElementById('closeDate').value,
                session: document.getElementById('session').value,
                stopLossPips: parseFloat(document.getElementById('stopLossPips').value) || 0,
                lotSize: parseFloat(document.getElementById('lotSize').value) || 0,
                notes: document.getElementById('tradeNotes').value.trim()
            };

            // Validaci√≥n de pips/dinero
            if ((tradeData.pipsWon > 0 && tradeData.pipsLost > 0) || (tradeData.moneyWon > 0 && tradeData.moneyLost > 0)) {
                alert('‚ùå No puedes registrar ganancias y p√©rdidas simult√°neamente. Ingresa valores solo en una de las dos categor√≠as.');
                return;
            }

            tradeData.totalPips = tradeData.pipsWon - tradeData.pipsLost;
            tradeData.totalMoney = tradeData.moneyWon - tradeData.moneyLost;
            tradeData.riskReward = tradeData.stopLossPips > 0 ? (Math.abs(tradeData.totalPips) / tradeData.stopLossPips) : 0;
            tradeData.timestamp = new Date(tradeData.closeDate + 'T00:00:00').getTime();

            if (editId) { // Modo Edici√≥n
                const tradeIndex = trades.findIndex(t => t.id === editId);
                if (tradeIndex > -1) {
                    const originalTrade = trades[tradeIndex];
                    trades[tradeIndex] = { ...originalTrade, ...tradeData };
                }
                document.getElementById('editTradeId').value = '';
                document.getElementById('submitTradeBtn').innerText = 'üíæ Registrar Operaci√≥n';
                document.getElementById('submitTradeBtn').classList.remove('btn-primary');
                document.getElementById('submitTradeBtn').classList.add('btn-success');
            } else { // Modo A√±adir
                tradeData.id = tradeIdCounter++;
                trades.push(tradeData);
            }
            
            this.reset();
            saveData();
            refreshAll();
        });

        // Toggle logic for input fields
        const moneyWonInput = document.getElementById('moneyWon');
        const moneyLostInput = document.getElementById('moneyLost');
        const pipsWonInput = document.getElementById('pipsWon');
        const pipsLostInput = document.getElementById('pipsLost');

        function setupToggle(input, toggleAttribute) {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                if (value > 0) {
                    if (toggleAttribute === 'won') {
                        moneyLostInput.value = '';
                        pipsLostInput.value = '';
                    } else if (toggleAttribute === 'lost') {
                        moneyWonInput.value = '';
                        pipsWonInput.value = '';
                    }
                }
            });
        }

        setupToggle(moneyWonInput, 'won');
        setupToggle(moneyLostInput, 'lost');
        setupToggle(pipsWonInput, 'won');
        setupToggle(pipsLostInput, 'lost');

        // ===================================
        // ACTUALIZACI√ìN DE UI Y RENDERIZADO
        // ===================================
        function populateAccountSelects() {
            const accountSelects = document.querySelectorAll('#accountSelect, #posCalcAccount');
            accountSelects.forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = '<option value="">Seleccionar cuenta</option>';
                accounts.forEach(acc => {
                    select.innerHTML += `<option value="${acc.id}">${acc.name} ($${acc.currentBalance.toFixed(2)})</option>`;
                });
                select.value = selectedValue;
            });
        }
        
        function updateAccountBalances() {
            accounts.forEach(account => {
                const totalPnL = trades
                    .filter(trade => trade.accountId === account.id)
                    .reduce((sum, trade) => sum + trade.totalMoney, 0);
                account.currentBalance = account.initialCapital + totalPnL;
            });
        }

        function updateAccountsDisplay() {
            const container = document.getElementById('accountsList');
            container.innerHTML = '';
            accounts.forEach(account => {
                const totalPnL = account.currentBalance - account.initialCapital;
                const percentageChange = account.initialCapital !== 0 ? ((totalPnL / account.initialCapital) * 100) : 0;
                container.innerHTML += `
                    <div class="account-card">
                        <div>
                            <h3>${account.name}</h3>
                            <p>Capital inicial: <strong>$${account.initialCapital.toFixed(2)}</strong></p>
                            <p>Balance actual: <strong>$${account.currentBalance.toFixed(2)}</strong></p>
                            <p>P&L Total: <span class="${totalPnL >= 0 ? 'profit' : 'loss'}">$${totalPnL.toFixed(2)}</span> (${percentageChange.toFixed(2)}%)</p>
                        </div>
                        <div class="account-actions">
                            <button onclick="editAccount(${account.id})" class="btn-small btn-secondary" title="Editar Nombre">‚úèÔ∏è</button>
                            <button onclick="deleteAccount(${account.id})" class="btn-small btn-danger" title="Eliminar Cuenta">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
            populateAccountSelects();
        }

        function filterTrades() {
            const filterValue = document.getElementById('filterPair').value.toLowerCase();
            updateTradesDisplay(filterValue);
        }

        function clearFilter() {
            document.getElementById('filterPair').value = '';
            updateTradesDisplay();
        }

        function updateTradesDisplay(filter = '') {
            const tbody = document.getElementById('tradesBody');
            tbody.innerHTML = '';
            const sortedTrades = [...trades].sort((a, b) => b.timestamp - a.timestamp);
            const filteredTrades = sortedTrades.filter(trade => {
                if (filter === '') return true;
                return trade.currencyPair.toLowerCase().includes(filter);
            });

            filteredTrades.forEach(trade => {
                const account = accounts.find(acc => acc.id === trade.accountId);
                tbody.innerHTML += `
                    <tr>
                        <td>${account ? account.name : 'N/A'}</td>
                        <td>${trade.closeDate}</td>
                        <td>${trade.session}</td>
                        <td>${trade.currencyPair}</td>
                        <td>${trade.operationType}</td>
                        <td class="${trade.totalPips >= 0 ? 'profit' : 'loss'}">${trade.totalPips.toFixed(1)}</td>
                        <td class="${trade.totalMoney >= 0 ? 'profit' : 'loss'}"><strong>$${trade.totalMoney.toFixed(2)}</strong></td>
                        <td class="${trade.riskReward >= 1 ? 'profit' : 'loss'}">${trade.riskReward > 0 ? `1:${trade.riskReward.toFixed(2)}` : '--'}</td>
                        <td>
                            <button onclick="showNotes(${trade.id})" class="btn-small btn-secondary" title="Ver Notas">üìù</button>
                            <button onclick="editTrade(${trade.id})" class="btn-small btn-primary" title="Editar">‚úèÔ∏è</button>
                            <button onclick="deleteTrade(${trade.id})" class="btn-small btn-danger" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        }
        
        function updateReports() {
            const reportsContainer = document.getElementById('reportsContainer');
            reportsContainer.innerHTML = '';
            const allTrades = trades;

            // Render Report Cards
            accounts.forEach(account => {
                 const accountTrades = allTrades.filter(trade => trade.accountId === account.id);
                 if (accountTrades.length === 0) return;
                 const winningTrades = accountTrades.filter(t => t.totalMoney > 0);
                 const losingTrades = accountTrades.filter(t => t.totalMoney < 0);
                 const winRate = accountTrades.length > 0 ? (winningTrades.length / accountTrades.length * 100) : 0;
                 const totalPnL = account.currentBalance - account.initialCapital;
                 const totalMoneyWon = winningTrades.reduce((sum, t) => sum + t.moneyWon, 0);
                 const totalMoneyLost = Math.abs(losingTrades.reduce((sum, t) => sum + t.moneyLost, 0));
                 const profitFactor = totalMoneyLost > 0 ? (totalMoneyWon / totalMoneyLost) : (totalMoneyWon > 0 ? Infinity : 0);
                 const averageRR = accountTrades.filter(t => t.riskReward > 0).reduce((sum, t) => sum + t.riskReward, 0) / (accountTrades.filter(t => t.riskReward > 0).length || 1);
                 const maxDrawdown = calculateMaxDrawdown(accountTrades, account.initialCapital);

                 const reportCard = document.createElement('div');
                 reportCard.className = 'report-card';
                 reportCard.innerHTML = `
                    <div class="report-title">Reporte General: ${account.name}</div>
                    <div class="metric"><span class="metric-label">P&L Total:</span><span class="metric-value ${totalPnL >= 0 ? 'profit' : 'loss'}">$${totalPnL.toFixed(2)}</span></div>
                    <div class="metric"><span class="metric-label">Total Operaciones:</span><span class="metric-value">${accountTrades.length}</span></div>
                    <div class="metric"><span class="metric-label">Tasa de Acierto:</span><span class="percentage ${winRate >= 50 ? 'positive' : 'negative'}">${winRate.toFixed(1)}%</span></div>
                    <div class="metric"><span class="metric-label">Profit Factor:</span><span class="metric-value">${profitFactor === Infinity ? '‚àû' : profitFactor.toFixed(2)}</span></div>
                    <div class="metric"><span class="metric-label">R:R Promedio:</span><span class="metric-value">1:${averageRR.toFixed(2)}</span></div>
                    <div class="metric"><span class="metric-label">Max. Drawdown:</span><span class="metric-value loss">$${Math.abs(maxDrawdown).toFixed(2)}</span></div>
                 `;
                 reportsContainer.appendChild(reportCard);
            });

            // Update Charts
            if (balanceChart) balanceChart.destroy();
            if (assetPerformanceChart) assetPerformanceChart.destroy();
            if (dayPerformanceChart) dayPerformanceChart.destroy();
            if (typePerformanceChart) typePerformanceChart.destroy();
            if (pipsDistributionChart) pipsDistributionChart.destroy();

            const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
            const chartFontColor = isDarkTheme ? 'white' : 'black';
            const gridColor = isDarkTheme ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: chartFontColor } },
                    tooltip: { backgroundColor: isDarkTheme ? '#2d3748' : '#ffffff', titleColor: chartFontColor, bodyColor: chartFontColor }
                },
                scales: {
                    y: { ticks: { color: chartFontColor }, grid: { color: gridColor } },
                    x: { ticks: { color: chartFontColor }, grid: { color: gridColor } }
                }
            };
            
            // Balance Chart
            const balanceCtx = document.getElementById('balanceChart').getContext('2d');
            const primaryAccount = accounts[0];
            if (primaryAccount) {
                const accountTrades = trades.filter(t => t.accountId === primaryAccount.id).sort((a, b) => a.timestamp - b.timestamp);
                const balanceData = [primaryAccount.initialCapital];
                accountTrades.forEach(trade => balanceData.push(balanceData[balanceData.length - 1] + trade.totalMoney));

                const labels = ['Inicio', ...accountTrades.map((t,i) => `${t.closeDate} (${t.currencyPair})`)];
                
                balanceChart = new Chart(balanceCtx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: `Capital (${primaryAccount.name})`, data: balanceData, borderColor: '#3498db', tension: 0.1, fill: true, backgroundColor: 'rgba(52, 152, 219, 0.2)' }] },
                    options: {
                        ...chartOptions,
                        scales: {
                            ...chartOptions.scales,
                            x: {
                                ...chartOptions.scales.x,
                                ticks: { ...chartOptions.scales.x.ticks, maxRotation: 45, minRotation: 45 }
                            }
                        }
                    }
                });
            }

            // Asset Performance Chart
            const assetCtx = document.getElementById('assetPerformanceChart').getContext('2d');
            const assetData = allTrades.reduce((acc, trade) => {
                acc[trade.currencyPair] = (acc[trade.currencyPair] || 0) + trade.totalMoney;
                return acc;
            }, {});
            assetPerformanceChart = new Chart(assetCtx, {
                type: 'bar',
                data: { labels: Object.keys(assetData), datasets: [{ label: 'P&L por Activo', data: Object.values(assetData), backgroundColor: Object.values(assetData).map(v => v >= 0 ? '#27ae60' : '#e74c3c') }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, legend: { display: false } } }
            });

            // Day of Week Performance Chart
            const dayCtx = document.getElementById('dayPerformanceChart').getContext('2d');
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const dayData = Array(7).fill(0);
            allTrades.forEach(trade => {
                const dayIndex = new Date(trade.closeDate + 'T00:00:00').getDay();
                dayData[dayIndex] += trade.totalMoney;
            });
            dayPerformanceChart = new Chart(dayCtx, {
                type: 'bar',
                data: { labels: days, datasets: [{ label: 'P&L por D√≠a', data: dayData, backgroundColor: dayData.map(v => v >= 0 ? '#27ae60' : '#e74c3c') }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, legend: { display: false } } }
            });

            // Trade Type Performance Chart
            const typeCtx = document.getElementById('typePerformanceChart').getContext('2d');
            const typeData = allTrades.reduce((acc, trade) => {
                acc[trade.operationType] = (acc[trade.operationType] || 0) + trade.totalMoney;
                return acc;
            }, {});
            typePerformanceChart = new Chart(typeCtx, {
                type: 'pie',
                data: {
                    labels: ['Compra', 'Venta'],
                    datasets: [{
                        label: 'P&L por Tipo de Operaci√≥n',
                        data: [typeData['BUY'] || 0, typeData['SELL'] || 0],
                        backgroundColor: ['#3498db', '#e74c3c'],
                        hoverOffset: 4
                    }]
                },
                options: { ...chartOptions, scales: {} }
            });

            // Pips Distribution Chart
            const pipsCtx = document.getElementById('pipsDistributionChart').getContext('2d');
            const pipsData = allTrades.map(trade => trade.totalPips);
            const pipsBins = binData(pipsData, 10);
            pipsDistributionChart = new Chart(pipsCtx, {
                type: 'bar',
                data: {
                    labels: pipsBins.labels,
                    datasets: [{
                        label: 'Frecuencia de Pips',
                        data: pipsBins.data,
                        backgroundColor: pipsBins.labels.map(label => {
                            const range = label.split(' a ');
                            const start = parseFloat(range[0]);
                            return start >= 0 ? '#27ae60' : '#e74c3c';
                        })
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: { ...chartOptions.plugins, legend: { display: false } }
                }
            });
        }
        
        function calculateMaxDrawdown(trades, initialCapital) {
            let maxDrawdown = 0;
            let peak = initialCapital;
            let currentBalance = initialCapital;

            trades.forEach(trade => {
                currentBalance += trade.totalMoney;
                peak = Math.max(peak, currentBalance);
                const drawdown = peak - currentBalance;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
            });

            return maxDrawdown;
        }

        function binData(data, binSize) {
            if (data.length === 0) {
                return { labels: [], data: [] };
            }
            const min = Math.floor(Math.min(...data) / binSize) * binSize;
            const max = Math.ceil(Math.max(...data) / binSize) * binSize;
            const bins = {};
            for (let i = min; i <= max; i += binSize) {
                const label = `${i} a ${i + binSize - 1}`;
                bins[label] = 0;
            }
            data.forEach(value => {
                const binStart = Math.floor(value / binSize) * binSize;
                const label = `${binStart} a ${binStart + binSize - 1}`;
                if (bins[label] !== undefined) {
                    bins[label]++;
                }
            });
            return { labels: Object.keys(bins), data: Object.values(bins) };
        }
        
        function exportToCSV() {
            if (trades.length === 0) return alert('No hay datos para exportar.');
            const headers = ['ID', 'Cuenta', 'Fecha Cierre', 'Sesi√≥n', 'Par', 'Tipo', 'Pips Delta', 'P&L Total ($)', 'R:R', 'Stop Loss (Pips)', 'Lotaje', 'Notas'];
            const rows = trades.map(op => {
                const account = accounts.find(acc => acc.id === op.accountId);
                const sanitizedNotes = `"${(op.notes || '').replace(/"/g, '""')}"`;
                return [
                    op.id,
                    account ? account.name : 'N/A',
                    op.closeDate,
                    op.session,
                    op.currencyPair,
                    op.operationType,
                    op.totalPips.toFixed(1),
                    op.totalMoney.toFixed(2),
                    op.riskReward.toFixed(2),
                    op.stopLossPips.toFixed(1),
                    op.lotSize.toFixed(2),
                    sanitizedNotes
                ].join(',');
            });
            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historial_trading_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ===================================
        // INICIALIZACI√ìN Y EVENTOS GLOBALES
        // ===================================
        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            element.classList.add('active');
            
            if (tabName === 'reports') {
                refreshAll();
            }
        }
        
        function toggleTheme() {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.getElementById('theme-toggle').innerHTML = newTheme === 'dark' ? '‚òÄÔ∏è Modo Claro' : 'üåì Modo Oscuro';
            refreshAll();
        }

        function refreshAll() {
            updateAccountBalances();
            updateAccountsDisplay();
            updateTradesDisplay();
            updateReports();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').innerHTML = savedTheme === 'dark' ? '‚òÄÔ∏è Modo Claro' : 'üåì Modo Oscuro';
            
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            refreshAll();
        });
    </script>
</body>
</html>