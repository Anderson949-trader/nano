<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPTrading Pro Dashboard v3 - IA Mejorada</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');
    :root {
      --primary: #5a67d8; --secondary: #48bb78; --success: #10b981; --danger: #ef4444;
      --warning: #f97316; --dark: #1f2937; --dark-secondary: #374151; --light: #f3f4f6;
      --text: #e5e7eb; --text-light: #9ca3af; --border: #4b5563;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.15); --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.25);
      --gradient-primary: linear-gradient(135deg, #5a67d8 0%, #805ad5 100%);
      --gradient-card: linear-gradient(145deg, #2d3748 0%, #1f2937 100%);
    }
    body.light-mode {
      --dark: #f8fafc; --dark-secondary: #f1f5f9; --text: #1f2937; --text-light: #6b7280;
      --border: #e5e7eb; --gradient-card: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%);
    }
    body { font-family: 'Poppins', sans-serif; background: var(--dark); color: var(--text); line-height: 1.6; transition: background 0.3s ease, color 0.3s ease; }
    .main-container { max-width: 1800px; margin: 0 auto; padding: 30px; }
    .header { background: var(--gradient-primary); border-radius: 25px; padding: 50px; margin-bottom: 40px; text-align: center; position: relative; overflow: hidden; box-shadow: var(--shadow-lg); }
    .header h1 { color: white; font-size: 3.2rem; font-weight: 800; margin-bottom: 10px; text-shadow: 0 2px 5px rgba(0,0,0,0.4); }
    .header p { color: rgba(255,255,255,0.9); font-size: 1.3rem; max-width: 900px; margin: 0 auto; }
    .controls-bar { display: flex; justify-content: space-between; align-items: center; background: var(--dark-secondary); padding: 25px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow-lg); flex-wrap: wrap; gap: 15px; }
    .controls-bar > div { display: flex; gap: 15px; flex-wrap: wrap; }
    .btn { padding: 14px 28px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; gap: 10px; text-decoration: none; position: relative; overflow: hidden; }
    .btn-sm { padding: 8px 16px; font-size: 14px; border-radius: 8px; }
    .btn:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-icon { padding: 12px; font-size: 1.2em; }
    .card { background: var(--gradient-card); border-radius: 25px; padding: 35px; margin-bottom: 30px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
    .card h2, .card h3 { color: var(--text); font-size: 1.8rem; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 25px; }
    .input-group { display: flex; flex-direction: column; gap: 8px; }
    .input-group label { font-weight: 500; color: var(--text-light); font-size: 15px; }
    .form-control { padding: 14px 18px; border: 1px solid var(--border); border-radius: 12px; font-size: 15px; transition: all 0.3s ease; background: var(--dark-secondary); color: var(--text); }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(90, 103, 216, 0.2); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: var(--dark-secondary); padding: 25px; border-radius: 15px; text-align: center; }
    .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--text); margin-bottom: 5px; }
    .stat-card.profit .stat-value, .profit-text { color: var(--success) !important; }
    .stat-card.loss .stat-value, .loss-text { color: var(--danger) !important; }
    .stat-label { color: var(--text-light); font-size: 14px; font-weight: 500; }
    .table-container { background: var(--dark-secondary); border-radius: 15px; overflow-x: auto; box-shadow: var(--shadow-lg); margin-bottom: 30px; border: 1px solid var(--border); }
    .table { width: 100%; border-collapse: collapse; min-width: 900px; }
    .table th { background: #1f2937; color: var(--text-light); padding: 20px 18px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; }
    .light-mode .table th { background: #e5e7eb; }
    .table td { padding: 18px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 15px; }
    .table tbody tr:last-child td { border-bottom: none; }
    .table tbody tr:hover { background: var(--border); }
    .light-mode .table tbody tr:hover { background: #f3f4f6; }
    .badge { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; text-transform: capitalize; }
    .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .chart-container { background: var(--dark-secondary); padding: 30px; border-radius: 15px; height: 400px; margin-bottom: 30px; border: 1px solid var(--border); }
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    .progress-bar-container { width: 100%; background-color: var(--dark); border-radius: 10px; overflow: hidden; }
    .progress-bar { height: 20px; width: 0%; background: var(--gradient-primary); border-radius: 10px; transition: width 0.5s ease-in-out; text-align: center; color: white; font-weight: 600; line-height: 20px; font-size: 12px;}
    .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; }
    .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
    .modal-content { background: var(--dark-secondary); margin: 10% auto; padding: 40px; border-radius: 20px; max-width: 600px; box-shadow: var(--shadow-lg); position: relative; }
    .close-btn { color: var(--text-light); float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 15px; right: 25px; }
    
    @media (max-width: 1200px) { .grid-container { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
        .header h1 { font-size: 2rem; } .header p { font-size: 1rem; }
        .controls-bar { flex-direction: column; align-items: stretch; }
        .controls-bar > div { flex-direction: column; } .btn { width: 100%; justify-content: center; }
        .modal-content { width: 90%; margin: 20% auto; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark-mode">
  <div class="main-container">
    <div class="header">
      <h1>📈 GPTrading Pro Dashboard v3 - IA Mejorada</h1>
      <p>Gestión de Trading Avanzada con Análisis de Rendimiento y Gestión de Riesgo</p>
    </div>

    <div class="controls-bar">
      <div>
        <button class="btn btn-primary" onclick="toggleDarkMode()">🌓 Tema</button>
        <button class="btn btn-secondary" onclick="exportBackup()">💾 Exportar Backup (JSON)</button>
        <label for="import-json" class="btn btn-secondary" style="margin:0; cursor:pointer;">
          <input type="file" id="import-json" accept=".json" style="display:none;" onchange="importBackup(event)">
          📂 Importar Backup (JSON)
        </label>
      </div>
      <div>
        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Limpiar Todo</button>
      </div>
    </div>
    
    <div class="card">
        <h2>📊 Resumen de Estadísticas Globales</h2>
        <div class="stats-grid" id="global-stats"></div>
    </div>
    
    <div class="card">
        <h2>💡 Métricas de Trading Avanzadas</h2>
        <div class="stats-grid" id="advanced-metrics"></div>
    </div>

    <div class="card">
        <h2>🏦 Resumen por Cuenta</h2>
        <div id="account-stats-summary"></div>
    </div>
    
    <div class="grid-container">
        <div class="card">
            <h2>🎯 Metas y Objetivos</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Seleccionar Cuenta</label>
                    <select class="form-control" id="goal-account-select"></select>
                </div>
                <div class="input-group">
                    <label>Meta de Ganancia ($)</label>
                    <input type="number" class="form-control" id="goal-amount" placeholder="1000">
                </div>
            </div>
            <button class="btn btn-success" onclick="setGoal()">Establecer Meta</button>
        </div>

        <div class="card">
            <h2>🛡️ Calculadora de Gestión de Riesgo</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label>Capital de la Cuenta ($)</label>
                    <input type="number" class="form-control" id="risk-capital" placeholder="10000">
                </div>
                <div class="input-group">
                    <label>Riesgo por Operación (%)</label>
                    <input type="number" class="form-control" id="risk-percent" placeholder="1" value="1">
                </div>
            </div>
            <button class="btn btn-primary" onclick="calculateRisk()">Calcular Inversión</button>
            <div id="risk-result" style="margin-top: 15px; font-weight: 600;"></div>
        </div>
    </div>

    <div class="card grid-container">
      <div>
        <h2>➕ Agregar Nueva Operación</h2>
        <form id="add-operation-form" class="form-grid">
          <div class="input-group"> <label>Cuenta</label> <select class="form-control" id="account-select"></select> </div>
          <div class="input-group"> <label>Fecha</label> <input type="date" class="form-control" id="input-date"> </div>
          <div class="input-group"> <label>Operaciones Ganadas</label> <input type="number" class="form-control" id="input-win" placeholder="5" min="0"> </div>
          <div class="input-group"> <label>Operaciones Perdidas</label> <input type="number" class="form-control" id="input-loss" placeholder="2" min="0"> </div>
          <div class="input-group"> <label>Ganancia ($)</label> <input type="number" class="form-control" id="input-gain" placeholder="300.00" step="0.01" min="0"> </div>
          <div class="input-group"> <label>Pérdida ($)</label> <input type="number" class="form-control" id="input-loss-amount" placeholder="50.00" step="0.01" min="0"> </div>
        </form>
        <button class="btn btn-success" onclick="addOperation()">✅ Agregar Operación</button>
      </div>
      <div>
        <h2>🏦 Gestión de Cuentas</h2>
        <form id="add-account-form" class="form-grid">
          <div class="input-group"> <label>Nombre de la Cuenta</label> <input type="text" class="form-control" id="new-account-name" placeholder="Mi Cuenta Principal"> </div>
          <div class="input-group"> <label>Capital Inicial ($)</label> <input type="number" class="form-control" id="new-account-balance" placeholder="1000.00" step="0.01" min="0"> </div>
        </form>
        <button class="btn btn-primary" onclick="addAccount()">🏦 Crear Cuenta</button>
      </div>
    </div>
    
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>📜 Historial de Operaciones Activas</h2>
        <div class="pagination-controls" id="history-pagination"></div>
      </div>
      <div class="table-container">
        <table class="table">
          <thead><tr><th>Cuenta</th><th>Fecha</th><th>Gan/Perd</th><th>Ganancia</th><th>Pérdida</th><th>Neto</th><th>Acciones</th></tr></thead>
          <tbody id="operations-table"></tbody>
        </table>
      </div>
    </div>
    
    <div class="card">
        <h2>🗄️ Archivos por Periodo</h2>
        <div class="table-container">
            <table class="table">
                <thead><tr><th>Cuenta</th><th>Periodo</th><th>Capital Inicial</th><th>Ganancia Neta</th><th>Capital Final</th><th>Acciones</th></tr></thead>
                <tbody id="period-archives-table"></tbody>
            </table>
        </div>
    </div>

    <div class="grid-container">
        <div class="card">
            <h2>📈 Curva de Capital (Equity Curve)</h2>
            <div class="chart-container"><canvas id="equityChart"></canvas></div>
        </div>
        <div class="card">
            <h2>📊 Evolución Mensual</h2>
            <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
        </div>
    </div>
  </div>
  
  <div id="close-period-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('close-period-modal')">&times;</span>
      <h2>📦 Archivar Periodo</h2>
      <input type="hidden" id="close-period-account-id">
      <div class="form-grid">
        <div class="input-group">
          <label>Fecha de Inicio</label>
          <input type="date" id="close-period-start" class="form-control">
        </div>
        <div class="input-group">
          <label>Fecha de Fin</label>
          <input type="date" id="close-period-end" class="form-control">
        </div>
      </div>
      <button class="btn btn-primary" onclick="closePeriod()">Archivar Periodo</button>
    </div>
  </div>

  <div id="edit-operation-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('edit-operation-modal')">&times;</span>
        <h2>✏️ Editar Operación</h2>
        <input type="hidden" id="edit-op-id">
        <div id="edit-operation-form" class="form-grid">
            <div class="input-group"> <label>Fecha</label> <input type="date" class="form-control" id="edit-input-date"> </div>
            <div class="input-group"> <label>Operaciones Ganadas</label> <input type="number" class="form-control" id="edit-input-win" min="0"> </div>
            <div class="input-group"> <label>Operaciones Perdidas</label> <input type="number" class="form-control" id="edit-input-loss" min="0"> </div>
            <div class="input-group"> <label>Ganancia ($)</label> <input type="number" class="form-control" id="edit-input-gain" step="0.01" min="0"> </div>
            <div class="input-group"> <label>Pérdida ($)</label> <input type="number" class="form-control" id="edit-input-loss-amount" step="0.01" min="0"> </div>
        </div>
        <button class="btn btn-success" onclick="saveEditedOperation()">Guardar Cambios</button>
    </div>
  </div>
  
  <div id="archive-details-modal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
          <span class="close-btn" onclick="closeModal('archive-details-modal')">&times;</span>
          <h2 id="archive-details-title">Detalles del Archivo</h2>
          <div class="stats-grid" id="archive-details-stats"></div>
          <div class="table-container">
              <table class="table">
                  <thead><tr><th>Fecha</th><th>G/P</th><th>Ganancia</th><th>Pérdida</th><th>Neto</th></tr></thead>
                  <tbody id="archive-details-table"></tbody>
              </table>
          </div>
      </div>
  </div>

  <div id="notification-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1002; display: flex; flex-direction: column; gap: 10px;"></div>

  <script>
    // --- CONFIG & UTILS ---
    const STORAGE_KEYS = {
      operations: 'gp_trading_operations_v4',
      accounts: 'gp_trading_accounts_v4',
      archives: 'gp_trading_archives_v4',
      goals: 'gp_trading_goals_v4',
    };
    const ITEMS_PER_PAGE = 15;
    let currentPage = 1;
    let charts = {};

    const formatCurrency = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2 }).format(amount);
    const formatPercentage = (value) => `${(value || 0).toFixed(2)}%`;
    const getTodayDate = () => new Date().toISOString().slice(0, 10);
    const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    
    const showNotification = (message, type = 'success') => {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification btn btn-${type}`;
        notification.innerHTML = `<span>${message}</span>`;
        container.appendChild(notification);
        setTimeout(() => { notification.style.opacity = 0; setTimeout(() => notification.remove(), 500); }, 5000);
    };
    const loadData = (key) => JSON.parse(localStorage.getItem(key)) || [];
    const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
    const closeModal = (modalId) => document.getElementById(modalId).style.display = 'none';

    // --- DATA MIGRATION & BACKUP ---
    const migrateData = () => { /* Logic to migrate from older versions if needed */ };
    const exportBackup = () => {
        const backupData = {
            accounts: loadData(STORAGE_KEYS.accounts),
            operations: loadData(STORAGE_KEYS.operations),
            archives: loadData(STORAGE_KEYS.archives),
            goals: loadData(STORAGE_KEYS.goals),
        };
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `gptrading_backup_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
        showNotification('✅ Backup exportado exitosamente.');
    };
    const importBackup = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            if (!confirm('¿Estás seguro? Esto reemplazará TODOS los datos actuales.')) return;
            try {
                const data = JSON.parse(e.target.result);
                if (data.accounts && data.operations) {
                    saveData(STORAGE_KEYS.accounts, data.accounts);
                    saveData(STORAGE_KEYS.operations, data.operations);
                    saveData(STORAGE_KEYS.archives, data.archives || []);
                    saveData(STORAGE_KEYS.goals, data.goals || []);
                    refreshAll();
                    showNotification('✅ Backup importado exitosamente.');
                } else {
                    showNotification('⚠️ Archivo de backup inválido.', 'danger');
                }
            } catch (error) {
                showNotification('❌ Error al leer el archivo de backup.', 'danger');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    };

    // --- CORE LOGIC (Accounts, Operations, Goals) ---
    const addAccount = () => {
        const name = document.getElementById('new-account-name').value.trim();
        const balance = parseFloat(document.getElementById('new-account-balance').value) || 0;
        if (!name || balance < 0) { showNotification('⚠️ Datos de cuenta inválidos.', 'warning'); return; }
        const accounts = loadData(STORAGE_KEYS.accounts);
        if (accounts.find(acc => acc.name.toLowerCase() === name.toLowerCase())) { showNotification('⚠️ Ya existe una cuenta con ese nombre.', 'warning'); return; }
        accounts.push({ id: generateUniqueId(), name, initialBalance: balance, createdAt: new Date().toISOString() });
        saveData(STORAGE_KEYS.accounts, accounts);
        document.getElementById('add-account-form').reset();
        refreshAll();
        showNotification('✅ Cuenta creada exitosamente.');
    };
    
    const addOperation = () => {
        const accountName = document.getElementById('account-select').value;
        const date = document.getElementById('input-date').value;
        if (!accountName || !date) { showNotification('⚠️ Debes seleccionar cuenta y fecha.', 'warning'); return; }
        const operations = loadData(STORAGE_KEYS.operations);
        const newOp = {
            id: generateUniqueId(),
            account: accountName,
            date,
            wins: parseInt(document.getElementById('input-win').value) || 0,
            losses: parseInt(document.getElementById('input-loss').value) || 0,
            gain: parseFloat(document.getElementById('input-gain').value) || 0,
            lossAmount: parseFloat(document.getElementById('input-loss-amount').value) || 0,
        };
        newOp.netProfit = newOp.gain - newOp.lossAmount;
        operations.push(newOp);
        saveData(STORAGE_KEYS.operations, operations);
        document.getElementById('add-operation-form').reset();
        document.getElementById('input-date').value = getTodayDate();
        refreshAll();
        showNotification('✅ Operación agregada.');
    };
    
    const setGoal = () => {
        const accountId = document.getElementById('goal-account-select').value;
        const amount = parseFloat(document.getElementById('goal-amount').value);
        if (!accountId || isNaN(amount) || amount <= 0) { showNotification('⚠️ Debes seleccionar una cuenta y una meta válida.', 'warning'); return; }
        const goals = loadData(STORAGE_KEYS.goals);
        const goalIndex = goals.findIndex(g => g.accountId === accountId);
        if (goalIndex > -1) {
            goals[goalIndex].amount = amount;
        } else {
            goals.push({ accountId, amount });
        }
        saveData(STORAGE_KEYS.goals, goals);
        refreshAll();
        showNotification('🎯 Meta establecida/actualizada.');
    };
    
    const calculateRisk = () => {
        const capital = parseFloat(document.getElementById('risk-capital').value);
        const riskPercent = parseFloat(document.getElementById('risk-percent').value);
        const resultDiv = document.getElementById('risk-result');
        if (isNaN(capital) || isNaN(riskPercent) || capital <= 0 || riskPercent <= 0) {
            resultDiv.textContent = 'Por favor, ingresa valores válidos.';
            return;
        }
        const investment = capital * (riskPercent / 100);
        resultDiv.innerHTML = `Monto a arriesgar: <span class="profit-text">${formatCurrency(investment)}</span>`;
    };
    
    // --- RENDERING ---
    function refreshAll() {
        const accounts = loadData(STORAGE_KEYS.accounts);
        const operations = loadData(STORAGE_KEYS.operations);
        
        // Populate selects
        const accountSelects = document.querySelectorAll('#account-select, #goal-account-select');
        accountSelects.forEach(select => {
            select.innerHTML = '<option value="">Seleccionar cuenta...</option>';
            accounts.forEach(acc => select.innerHTML += `<option value="${acc.id}">${acc.name}</option>`);
            if (select.id === 'account-select') {
                const accNames = accounts.map(a => a.name);
                select.innerHTML = '<option value="">Seleccionar cuenta...</option>';
                accNames.forEach(name => select.innerHTML += `<option value="${name}">${name}</option>`);
            }
        });

        const allData = calculateAllStats(accounts, operations);
        
        renderGlobalStats(allData.global);
        renderAdvancedMetrics(allData.global);
        renderAccountStatsSummary(allData.perAccount);
        renderOperationsHistory(operations);
        renderPeriodArchives();
        renderCharts(allData);

        document.getElementById('input-date').value = getTodayDate();
    }

    function renderGlobalStats(stats) {
        const container = document.getElementById('global-stats');
        container.innerHTML = `
            <div class="stat-card"> <div class="stat-value">${formatCurrency(stats.currentCapital)}</div> <div class="stat-label">Capital Actual</div> </div>
            <div class="stat-card ${stats.netProfit >= 0 ? 'profit' : 'loss'}"> <div class="stat-value">${formatCurrency(stats.netProfit)}</div> <div class="stat-label">Ganancia Neta Total</div> </div>
            <div class="stat-card"> <div class="stat-value">${stats.totalWins}</div> <div class="stat-label">Operaciones Ganadas</div> </div>
            <div class="stat-card"> <div class="stat-value">${stats.totalLosses}</div> <div class="stat-label">Operaciones Perdidas</div> </div>
        `;
    }

    function renderAdvancedMetrics(stats) {
        const container = document.getElementById('advanced-metrics');
        container.innerHTML = `
            <div class="stat-card"> <div class="stat-value">${stats.profitFactor.toFixed(2)}</div> <div class="stat-label">Profit Factor</div> </div>
            <div class="stat-card loss"> <div class="stat-value">${formatCurrency(stats.maxDrawdown.amount)}</div> <div class="stat-label">Max Drawdown</div> </div>
            <div class="stat-card"> <div class="stat-value">${formatPercentage(stats.successRate)}</div> <div class="stat-label">Tasa de Éxito</div> </div>
            <div class="stat-card"> <div class="stat-value">${formatPercentage(stats.maxDrawdown.percentage)}</div> <div class="stat-label">Max Drawdown (%)</div> </div>
        `;
    }
    
    function renderAccountStatsSummary(accountStats) {
        const container = document.getElementById('account-stats-summary');
        const goals = loadData(STORAGE_KEYS.goals);
        container.innerHTML = '';
        if (Object.keys(accountStats).length === 0) { container.innerHTML = '<p style="text-align: center;">No hay cuentas. Crea una para empezar.</p>'; return; }

        for (const id in accountStats) {
            const acc = accountStats[id];
            const goal = goals.find(g => g.accountId === id);
            let goalHtml = '';
            if (goal) {
                const progress = Math.min((acc.netProfit / goal.amount) * 100, 100);
                goalHtml = `
                    <div class="stat-label" style="margin-top: 10px;">Meta: ${formatCurrency(goal.amount)}</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progress}%;">${progress.toFixed(0)}%</div>
                    </div>
                `;
            }

            container.innerHTML += `
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${acc.name}</span>
                        <div>
                            <button class="btn btn-secondary btn-icon" title="Archivar Periodo" onclick="showClosePeriodDialog('${id}')">📦</button>
                            <button class="btn btn-danger btn-icon" title="Eliminar Cuenta" onclick="deleteAccount('${id}')">🗑️</button>
                        </div>
                    </h3>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value">${formatCurrency(acc.initialBalance)}</div><div class="stat-label">Capital Inicial</div></div>
                        <div class="stat-card"><div class="stat-value">${formatCurrency(acc.currentCapital)}</div><div class="stat-label">Capital Actual</div></div>
                        <div class="stat-card ${acc.netProfit >= 0 ? 'profit' : 'loss'}"><div class="stat-value">${formatCurrency(acc.netProfit)}</div><div class="stat-label">Ganancia Neta</div></div>
                        <div class="stat-card"><div class="stat-value">${formatPercentage(acc.roi)}</div><div class="stat-label">Retorno (%)</div></div>
                    </div>
                    ${goalHtml}
                </div>
            `;
        }
    }
    
    function renderOperationsHistory(operations) {
        const tableBody = document.getElementById('operations-table');
        const paginationContainer = document.getElementById('history-pagination');
        tableBody.innerHTML = '';
        paginationContainer.innerHTML = '';

        const sortedOps = [...operations].sort((a,b) => new Date(b.date) - new Date(a.date));
        const totalPages = Math.ceil(sortedOps.length / ITEMS_PER_PAGE);
        const paginatedOps = sortedOps.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

        if(paginatedOps.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No hay operaciones activas.</td></tr>`;
            return;
        }

        paginatedOps.forEach(op => {
            const row = tableBody.insertRow();
            const netClass = op.netProfit >= 0 ? 'profit-text' : 'loss-text';
            row.innerHTML = `
                <td>${op.account}</td>
                <td>${op.date}</td>
                <td>${op.wins} / ${op.losses}</td>
                <td class="profit-text">${formatCurrency(op.gain)}</td>
                <td class="loss-text">${formatCurrency(op.lossAmount)}</td>
                <td class="${netClass}">${formatCurrency(op.netProfit)}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="showEditOperationModal('${op.id}')">✏️</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteOperation('${op.id}')">🗑️</button>
                </td>
            `;
        });
        
        // Pagination controls
        if (totalPages > 1) {
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-secondary'}`;
                btn.textContent = i;
                btn.onclick = () => { currentPage = i; renderOperationsHistory(operations); };
                paginationContainer.appendChild(btn);
            }
        }
    }
    
    function renderPeriodArchives() {
        const archives = loadData(STORAGE_KEYS.archives);
        const tableBody = document.getElementById('period-archives-table');
        tableBody.innerHTML = '';
        if(archives.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay periodos archivados.</td></tr>';
            return;
        }

        archives.sort((a,b) => new Date(b.archivedAt) - new Date(a.archivedAt)).forEach(archive => {
            const row = tableBody.insertRow();
            const netClass = archive.netProfit >= 0 ? 'badge-success' : 'badge-danger';
            row.innerHTML = `
                <td>${archive.accountName}</td>
                <td>${archive.startDate} al ${archive.endDate}</td>
                <td>${formatCurrency(archive.initialCapital)}</td>
                <td><span class="badge ${netClass}">${formatCurrency(archive.netProfit)}</span></td>
                <td>${formatCurrency(archive.finalCapital)}</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="showArchiveDetails('${archive.id}')">Ver</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteArchive('${archive.id}')">🗑️</button>
                </td>
            `;
        });
    }

    function renderCharts(allData) {
        // Destroy existing charts
        Object.values(charts).forEach(chart => chart.destroy());

        const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
        const monthlyLabels = Object.keys(allData.monthlySummary);
        const monthlyData = Object.values(allData.monthlySummary);
        charts.monthly = new Chart(ctxMonthly, {
            type: 'bar',
            data: {
                labels: monthlyLabels,
                datasets: [{ 
                    label: 'Ganancia Mensual Neta', 
                    data: monthlyData, 
                    backgroundColor: monthlyData.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.6)' : 'rgba(239, 68, 68, 0.6)') 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const ctxEquity = document.getElementById('equityChart').getContext('2d');
        charts.equity = new Chart(ctxEquity, {
            type: 'line',
            data: {
                labels: allData.equityCurve.labels,
                datasets: [{ 
                    label: 'Curva de Capital', 
                    data: allData.equityCurve.data,
                    borderColor: 'rgba(90, 103, 216, 1)',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
    
    // --- CALCULATIONS ---
    function calculateAllStats(accounts, operations) {
        let global = { totalWins: 0, totalLosses: 0, totalGain: 0, totalLossAmount: 0, netProfit: 0, initialCapital: 0, currentCapital: 0 };
        let perAccount = {};
        let equityPoints = [];
        let peakEquity = 0;
        
        accounts.forEach(acc => {
            global.initialCapital += acc.initialBalance;
            perAccount[acc.id] = { ...acc, currentCapital: acc.initialBalance, netProfit: 0, roi: 0, wins: 0, losses: 0, gain: 0, lossAmount: 0, equity: [acc.initialBalance] };
            peakEquity += acc.initialBalance;
        });

        let cumulativeCapital = global.initialCapital;
        equityPoints.push({ date: 'Inicio', capital: cumulativeCapital });

        const sortedOps = [...operations].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        sortedOps.forEach(op => {
            const accId = accounts.find(a => a.name === op.account)?.id;
            if (!accId || !perAccount[accId]) return;

            perAccount[accId].currentCapital += op.netProfit;
            perAccount[accId].netProfit += op.netProfit;
            perAccount[accId].wins += op.wins;
            perAccount[accId].losses += op.losses;
            perAccount[accId].gain += op.gain;
            perAccount[accId].lossAmount += op.lossAmount;
            
            cumulativeCapital += op.netProfit;
            equityPoints.push({ date: op.date, capital: cumulativeCapital });
        });
        
        // Final calculations
        global.currentCapital = Object.values(perAccount).reduce((sum, acc) => sum + acc.currentCapital, 0);
        global.netProfit = global.currentCapital - global.initialCapital;
        global.totalWins = sortedOps.reduce((sum, op) => sum + op.wins, 0);
        global.totalLosses = sortedOps.reduce((sum, op) => sum + op.losses, 0);
        
        Object.values(perAccount).forEach(acc => {
            acc.roi = acc.initialBalance > 0 ? (acc.netProfit / acc.initialBalance) * 100 : 0;
        });
        
        // Advanced Metrics
        const grossProfit = sortedOps.reduce((sum, op) => sum + op.gain, 0);
        const grossLoss = sortedOps.reduce((sum, op) => sum + op.lossAmount, 0);
        global.profitFactor = grossLoss > 0 ? grossProfit / grossLoss : Infinity;
        global.successRate = (global.totalWins + global.totalLosses) > 0 ? (global.totalWins / (global.totalWins + global.totalLosses)) * 100 : 0;
        
        // Max Drawdown Calculation
        let peak = -Infinity;
        let maxDrawdown = { amount: 0, percentage: 0 };
        equityPoints.forEach(point => {
            if (point.capital > peak) peak = point.capital;
            const drawdownAmount = peak - point.capital;
            if (drawdownAmount > maxDrawdown.amount) maxDrawdown.amount = drawdownAmount;
        });
        maxDrawdown.percentage = peak > 0 ? (maxDrawdown.amount / peak) * 100 : 0;
        global.maxDrawdown = maxDrawdown;

        // Monthly Summary
        const monthlySummary = sortedOps.reduce((acc, op) => {
            const month = op.date.slice(0, 7);
            acc[month] = (acc[month] || 0) + op.netProfit;
            return acc;
        }, {});
        
        return {
            global,
            perAccount,
            monthlySummary,
            equityCurve: {
                labels: equityPoints.map(p => p.date),
                data: equityPoints.map(p => p.capital)
            }
        };
    }
    
    // --- ACTIONS & MODALS ---
    function deleteAccount(accountId) {
        if (!confirm('¿Seguro? Se borrará la cuenta, sus operaciones, archivos y metas.')) return;
        let accounts = loadData(STORAGE_KEYS.accounts);
        const account = accounts.find(a => a.id === accountId);
        if (!account) return;
        
        saveData(STORAGE_KEYS.accounts, accounts.filter(a => a.id !== accountId));
        saveData(STORAGE_KEYS.operations, loadData(STORAGE_KEYS.operations).filter(op => op.account !== account.name));
        saveData(STORAGE_KEYS.archives, loadData(STORAGE_KEYS.archives).filter(ar => ar.accountId !== accountId));
        saveData(STORAGE_KEYS.goals, loadData(STORAGE_KEYS.goals).filter(g => g.accountId !== accountId));
        
        refreshAll();
        showNotification(`🗑️ Cuenta "${account.name}" eliminada.`, 'danger');
    }

    function deleteOperation(opId) {
        if (!confirm('¿Seguro que quieres eliminar esta operación?')) return;
        let operations = loadData(STORAGE_KEYS.operations);
        saveData(STORAGE_KEYS.operations, operations.filter(op => op.id !== opId));
        refreshAll();
        showNotification('🗑️ Operación eliminada.', 'danger');
    }

    function showEditOperationModal(opId) {
        const op = loadData(STORAGE_KEYS.operations).find(o => o.id === opId);
        if (!op) return;
        document.getElementById('edit-op-id').value = op.id;
        document.getElementById('edit-input-date').value = op.date;
        document.getElementById('edit-input-win').value = op.wins;
        document.getElementById('edit-input-loss').value = op.losses;
        document.getElementById('edit-input-gain').value = op.gain;
        document.getElementById('edit-input-loss-amount').value = op.lossAmount;
        document.getElementById('edit-operation-modal').style.display = 'block';
    }

    function saveEditedOperation() {
        const opId = document.getElementById('edit-op-id').value;
        let operations = loadData(STORAGE_KEYS.operations);
        const opIndex = operations.findIndex(o => o.id === opId);
        if (opIndex === -1) return;
        
        operations[opIndex].date = document.getElementById('edit-input-date').value;
        operations[opIndex].wins = parseInt(document.getElementById('edit-input-win').value) || 0;
        operations[opIndex].losses = parseInt(document.getElementById('edit-input-loss').value) || 0;
        operations[opIndex].gain = parseFloat(document.getElementById('edit-input-gain').value) || 0;
        operations[opIndex].lossAmount = parseFloat(document.getElementById('edit-input-loss-amount').value) || 0;
        operations[opIndex].netProfit = operations[opIndex].gain - operations[opIndex].lossAmount;

        saveData(STORAGE_KEYS.operations, operations);
        closeModal('edit-operation-modal');
        refreshAll();
        showNotification('✅ Operación actualizada.');
    }
    
    // Period Archiving
    function showClosePeriodDialog(accountId) {
        document.getElementById('close-period-account-id').value = accountId;
        document.getElementById('close-period-modal').style.display = 'block';
    }
    
    function closePeriod() {
        const accountId = document.getElementById('close-period-account-id').value;
        const startDate = document.getElementById('close-period-start').value;
        const endDate = document.getElementById('close-period-end').value;

        if (!accountId || !startDate || !endDate || startDate > endDate) {
            showNotification('⚠️ Por favor, selecciona una cuenta y un rango de fechas válido.', 'warning');
            return;
        }

        let accounts = loadData(STORAGE_KEYS.accounts);
        let operations = loadData(STORAGE_KEYS.operations);
        let archives = loadData(STORAGE_KEYS.archives);
        const account = accounts.find(acc => acc.id === accountId);
        if (!account) return;

        const opsToArchive = operations.filter(op => op.account === account.name && op.date >= startDate && op.date <= endDate);
        if (opsToArchive.length === 0) {
            showNotification('⚠️ No se encontraron operaciones en el periodo seleccionado.', 'warning');
            return;
        }

        const periodNetProfit = opsToArchive.reduce((sum, op) => sum + op.netProfit, 0);
        let balanceBeforePeriod = account.initialBalance + operations.filter(op => op.account === account.name && op.date < startDate).reduce((sum, op) => sum + op.netProfit, 0);
        const endOfPeriodBalance = balanceBeforePeriod + periodNetProfit;

        if (!confirm(`¿Estás seguro?\nSe archivarán ${opsToArchive.length} operaciones del ${startDate} al ${endDate} para "${account.name}".\nEl nuevo capital inicial de la cuenta será ${formatCurrency(endOfPeriodBalance)}.`)) return;

        archives.push({
            id: generateUniqueId(), accountId, accountName: account.name, startDate, endDate,
            initialCapital: balanceBeforePeriod, finalCapital: endOfPeriodBalance,
            netProfit: periodNetProfit, operations: opsToArchive, archivedAt: new Date().toISOString()
        });

        account.initialBalance = endOfPeriodBalance;
        const remainingOps = operations.filter(op => !opsToArchive.some(archivedOp => archivedOp.id === op.id));

        saveData(STORAGE_KEYS.archives, archives);
        saveData(STORAGE_KEYS.accounts, accounts);
        saveData(STORAGE_KEYS.operations, remainingOps);

        closeModal('close-period-modal');
        refreshAll();
        showNotification('📦 Periodo archivado exitosamente.');
    }

    function showArchiveDetails(archiveId) {
        const archive = loadData(STORAGE_KEYS.archives).find(a => a.id === archiveId);
        if (!archive) return;

        document.getElementById('archive-details-title').textContent = `Detalles: ${archive.accountName} (${archive.startDate} - ${archive.endDate})`;
        
        document.getElementById('archive-details-stats').innerHTML = `
            <div class="stat-card"><div class="stat-value">${formatCurrency(archive.initialCapital)}</div><div class="stat-label">Capital Inicial</div></div>
            <div class="stat-card profit"><div class="stat-value">${formatCurrency(archive.netProfit)}</div><div class="stat-label">Ganancia Neta</div></div>
            <div class="stat-card"><div class="stat-value">${formatCurrency(archive.finalCapital)}</div><div class="stat-label">Capital Final</div></div>
        `;

        const tableBody = document.getElementById('archive-details-table');
        tableBody.innerHTML = '';
        archive.operations.forEach(op => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${op.date}</td>
                <td>${op.wins}/${op.losses}</td>
                <td class="profit-text">${formatCurrency(op.gain)}</td>
                <td class="loss-text">${formatCurrency(op.lossAmount)}</td>
                <td class="${op.netProfit >= 0 ? 'profit-text' : 'loss-text'}">${formatCurrency(op.netProfit)}</td>
            `;
        });
        document.getElementById('archive-details-modal').style.display = 'block';
    }
    
    function deleteArchive(archiveId) {
        if (!confirm('¿Seguro que quieres eliminar este archivo? Las operaciones NO se restaurarán. Esta acción es permanente.')) return;
        let archives = loadData(STORAGE_KEYS.archives);
        saveData(STORAGE_KEYS.archives, archives.filter(a => a.id !== archiveId));
        refreshAll();
        showNotification('🗑️ Archivo eliminado.', 'danger');
    }

    function toggleDarkMode() {
      document.body.classList.toggle('light-mode');
    };
    
    function clearAllData() {
        if (confirm('¿ESTÁS SEGURO? Se borrarán TODOS los datos de la aplicación de forma irreversible.')) {
            localStorage.clear();
            refreshAll();
            showNotification('💥 Todos los datos han sido eliminados.', 'danger');
        }
    }
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        migrateData();
        refreshAll();
    });

  </script>
</body>
</html>